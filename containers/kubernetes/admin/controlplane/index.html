<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="FÃ¡bio Santos">
        <link rel="canonical" href="https://fdmsantos.github.io/MyDocs/containers/kubernetes/admin/controlplane/">
        <link rel="shortcut icon" href="../../../../img/favicon.ico">
        <title>Control Plane - MyDocs</title>
        <link href="../../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/darcula.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../../..">MyDocs</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../../../..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">AWS <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Networking</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../aws/networking/vpc/">VPC</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Compute</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../aws/compute/ec2/">EC2</a>
</li>
            
<li >
    <a href="../../../../aws/compute/ebs/">EBS</a>
</li>
            
<li >
    <a href="../../../../aws/compute/elb/">ELB</a>
</li>
            
<li >
    <a href="../../../../aws/compute/lambda/">Lambda</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Application Integration</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../aws/applicationIntegration/stepfunctions/">Step Functions</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Management</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../aws/management/cloudformation/">Cloudformation</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Developer</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../aws/developer/codecommit/">CodeCommit</a>
</li>
            
<li >
    <a href="../../../../aws/developer/codebuild/">CodeBuild</a>
</li>
            
<li >
    <a href="../../../../aws/developer/codedeploy/">CodeDeploy</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Database</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../aws/database/rds/">RDS</a>
</li>
            
<li >
    <a href="../../../../aws/database/elasticache/">Elasticache</a>
</li>
            
<li >
    <a href="../../../../aws/database/redshift/">Redshift</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Storage</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../aws/storage/efs/">EFS</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Security</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../aws/security/acm/">ACM</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Containers <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Kubernetes</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Admin</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../admin/">Admin</a>
</li>
            
<li >
    <a href="../etcd/">Etcd</a>
</li>
            
<li class="active">
    <a href="./">Control Plane</a>
</li>
            
<li >
    <a href="../networking/">Networking</a>
</li>
            
<li >
    <a href="../nodes/">Nodes</a>
</li>
            
<li >
    <a href="../security/">Security</a>
</li>
            
<li >
    <a href="../taint/">Taint</a>
</li>
            
<li >
    <a href="../monitoring/">Monitoring</a>
</li>
            
<li >
    <a href="../kops/">Kops</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Development</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../development/pods/">Pods</a>
</li>
            
<li >
    <a href="../../development/deployments/">Deployments</a>
</li>
            
<li >
    <a href="../../development/services/">Services</a>
</li>
            
<li >
    <a href="../../development/persistentvolumes/">PersistentVolumes</a>
</li>
            
<li >
    <a href="../../development/ingress/">Ingress</a>
</li>
            
<li >
    <a href="../../development/replicasets/">ReplicaSets</a>
</li>
            
<li >
    <a href="../../development/daemonsets/">DaemonSets</a>
</li>
            
<li >
    <a href="../../development/secrets_configmaps/">Secrets&ConfigMaps</a>
</li>
            
<li >
    <a href="../../development/statefulsets/">StatefulSets</a>
</li>
            
<li >
    <a href="../../development/jobs/">Jobs</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Deploy AWS KubeAdm</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../deploy_aws_kubeadm/iam/">IAM</a>
</li>
            
<li >
    <a href="../../deploy_aws_kubeadm/vpc/">VPC</a>
</li>
            
<li >
    <a href="../../deploy_aws_kubeadm/route53/">Route53</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">DevOps <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">IAAS</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../devops/iaas/packer/">Packer</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Databases <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">ELK Stack</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../elk/queries/">ESQueries</a>
</li>
            
<li >
    <a href="../../../../elk/admin/">Administration</a>
</li>
            
<li >
    <a href="../../../../elk/kibana/">Kibana</a>
</li>
            
<li >
    <a href="../../../../elk/beats/">Beats</a>
</li>
            
<li >
    <a href="../../../../elk/snapshotsAndRestore/">Snapshots&Restore</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Unix <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Commands</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../unix/commands/disks/">Disks</a>
</li>
            
<li >
    <a href="../../../../unix/commands/filesystem/">Filesystem</a>
</li>
            
<li >
    <a href="../../../../unix/commands/logging/">Logging</a>
</li>
            
<li >
    <a href="../../../../unix/commands/kernel/">Kernel</a>
</li>
            
<li >
    <a href="../../../../unix/commands/networking/">Networking</a>
</li>
            
<li >
    <a href="../../../../unix/commands/security/">Security</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Software</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Mail</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../unix/software/mail/postfix/">Postfix</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Programming</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../unix/software/programming/php/">PHP</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Virtualization</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../unix/software/virtualization/virsh/">Virsh</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">OperationSystems</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../unix/os/redhat/">Redhat</a>
</li>
            
<li >
    <a href="../../../../unix/os/debian/">Debian</a>
</li>
            
<li >
    <a href="../../../../unix/os/archlinux/">Archlinux</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developer <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Testing</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">RobotFramework</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../developer/testing/robotframework/gettingstarted/">GettingStarted</a>
</li>
            
<li >
    <a href="../../../../developer/testing/robotframework/robotfile/">RobotFile</a>
</li>
            
<li >
    <a href="../../../../developer/testing/robotframework/pom/">PageObjectModel</a>
</li>
            
<li >
    <a href="../../../../developer/testing/robotframework/seleniumLibrary/">SeleniumLibrary</a>
</li>
            
<li >
    <a href="../../../../developer/testing/robotframework/ddd/">DataDrivenTest</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Sdn <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Cisco ACI</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../sdn/ciscoAci/cobra/">Cobra</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../etcd/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../networking/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/fdmsantos/MyDocs/edit/master/docs/containers/kubernetes/admin/controlplane.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#master">Master</a></li>
            <li><a href="#install-binaries">Install Binaries</a></li>
            <li><a href="#api-server">API-Server</a></li>
            <li><a href="#controller-manager">Controller Manager</a></li>
            <li><a href="#scheduler">Scheduler</a></li>
            <li><a href="#rbac">RBAC</a></li>
        <li class="main "><a href="#nodes">Nodes</a></li>
            <li><a href="#install-binaries_1">Install Binaries</a></li>
            <li><a href="#containerd">ContainerD</a></li>
            <li><a href="#kubelet">Kubelet</a></li>
            <li><a href="#kube-proxy">Kube-Proxy</a></li>
        <li class="main "><a href="#commands">Commands</a></li>
            <li><a href="#components-status">Components Status</a></li>
        <li class="main "><a href="#enable-http-health-checks">Enable HTTP Health Checks</a></li>
            <li><a href="#using-nginx-load-balancer">Using Nginx Load Balancer</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="master">Master</h1>
<h2 id="install-binaries">Install Binaries</h2>
<pre><code class="bash"># You can install the control plane binaries on each master node like this:
sudo mkdir -p /etc/kubernetes/config
wget -q --timestamping \
  &quot;https://storage.googleapis.com/kubernetes-release/release/v1.10.2/bin/linux/amd64/kube-apiserver&quot; \
  &quot;https://storage.googleapis.com/kubernetes-release/release/v1.10.2/bin/linux/amd64/kube-controller-manager&quot; \
  &quot;https://storage.googleapis.com/kubernetes-release/release/v1.10.2/bin/linux/amd64/kube-scheduler&quot; \
  &quot;https://storage.googleapis.com/kubernetes-release/release/v1.10.2/bin/linux/amd64/kubectl&quot;
chmod +x kube-apiserver kube-controller-manager kube-scheduler kubectl
sudo mv kube-apiserver kube-controller-manager kube-scheduler kubectl /usr/local/bin/
</code></pre>

<h2 id="api-server">API-Server</h2>
<h3 id="setting-up">Setting Up</h3>
<pre><code class="bash"># You can configure the Kubernetes API server like so:
sudo mkdir -p /var/lib/kubernetes/
sudo cp ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem \
  service-account-key.pem service-account.pem \
  encryption-config.yaml /var/lib/kubernetes/

# Set some environment variables that will be used to create the systemd unit file. Make sure you replace the placeholders with their actual values:
export INTERNAL_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)
export CONTROLLER0_IP=&lt;private ip of controller 0&gt;
export CONTROLLER1_IP=&lt;private ip of controller 1&gt;

# Generate the kube-apiserver unit file for systemd:
cat &lt;&lt; EOF | sudo tee /etc/systemd/system/kube-apiserver.service
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-apiserver \\
  --advertise-address=${INTERNAL_IP} \\
  --allow-privileged=true \\
  --apiserver-count=3 \\
  --audit-log-maxage=30 \\
  --audit-log-maxbackup=3 \\
  --audit-log-maxsize=100 \\
  --audit-log-path=/var/log/audit.log \\
  --authorization-mode=Node,RBAC \\
  --bind-address=0.0.0.0 \\
  --client-ca-file=/var/lib/kubernetes/ca.pem \\
  --enable-admission-plugins=Initializers,NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\
  --enable-swagger-ui=true \\
  --etcd-cafile=/var/lib/kubernetes/ca.pem \\
  --etcd-certfile=/var/lib/kubernetes/kubernetes.pem \\
  --etcd-keyfile=/var/lib/kubernetes/kubernetes-key.pem \\
  --etcd-servers=https://$CONTROLLER0_IP:2379,https://$CONTROLLER1_IP:2379 \\
  --event-ttl=1h \\
  --experimental-encryption-provider-config=/var/lib/kubernetes/encryption-config.yaml \\
  --kubelet-certificate-authority=/var/lib/kubernetes/ca.pem \\
  --kubelet-client-certificate=/var/lib/kubernetes/kubernetes.pem \\
  --kubelet-client-key=/var/lib/kubernetes/kubernetes-key.pem \\
  --kubelet-https=true \\
  --runtime-config=api/all \\
  --service-account-key-file=/var/lib/kubernetes/service-account.pem \\
  --service-cluster-ip-range=10.32.0.0/24 \\
  --service-node-port-range=30000-32767 \\
  --tls-cert-file=/var/lib/kubernetes/kubernetes.pem \\
  --tls-private-key-file=/var/lib/kubernetes/kubernetes-key.pem \\
  --v=2 \\
  --kubelet-preferred-address-types=InternalIP,InternalDNS,Hostname,ExternalIP,ExternalDNS
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# Start and enable the service:

sudo systemctl daemon-reload
sudo systemctl enable kube-apiserver
sudo systemctl start kube-apiserver
sudo systemctl status kube-apiserver

</code></pre>

<h2 id="controller-manager">Controller Manager</h2>
<h3 id="setting-up_1">Setting Up</h3>
<pre><code class="bash"># You can configure the Kubernetes Controller Manager like so:
sudo cp kube-controller-manager.kubeconfig /var/lib/kubernetes/

# Generate the kube-controller-manager systemd unit file:
cat &lt;&lt; EOF | sudo tee /etc/systemd/system/kube-controller-manager.service
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-controller-manager \\
  --address=0.0.0.0 \\
  --cluster-cidr=10.200.0.0/16 \\
  --cluster-name=kubernetes \\
  --cluster-signing-cert-file=/var/lib/kubernetes/ca.pem \\
  --cluster-signing-key-file=/var/lib/kubernetes/ca-key.pem \\
  --kubeconfig=/var/lib/kubernetes/kube-controller-manager.kubeconfig \\
  --leader-elect=true \\
  --root-ca-file=/var/lib/kubernetes/ca.pem \\
  --service-account-private-key-file=/var/lib/kubernetes/service-account-key.pem \\
  --service-cluster-ip-range=10.32.0.0/24 \\
  --use-service-account-credentials=true \\
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# Start and enable the service:
sudo systemctl daemon-reload
sudo systemctl enable kube-controller-manager
sudo systemctl start kube-controller-manager
sudo systemctl status kube-controller-manager

</code></pre>

<h2 id="scheduler">Scheduler</h2>
<h3 id="setting-up_2">Setting Up</h3>
<pre><code class="bash"># Copy kube-scheduler.kubeconfig into the proper location:
sudo cp kube-scheduler.kubeconfig /var/lib/kubernetes/

# Generate the kube-scheduler yaml config file.
cat &lt;&lt; EOF | sudo tee /etc/kubernetes/config/kube-scheduler.yaml
apiVersion: componentconfig/v1alpha1
kind: KubeSchedulerConfiguration
clientConnection:
  kubeconfig: &quot;/var/lib/kubernetes/kube-scheduler.kubeconfig&quot;
leaderElection:
  leaderElect: true
EOF

# Create the kube-scheduler systemd unit file:
cat &lt;&lt; EOF | sudo tee /etc/systemd/system/kube-scheduler.service
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-scheduler \\
  --config=/etc/kubernetes/config/kube-scheduler.yaml \\
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# Start and enable the service:
sudo systemctl daemon-reload
sudo systemctl enable kube-scheduler
sudo systemctl start kube-scheduler
sudo systemctl status kube-scheduler
</code></pre>

<h3 id="default-scheduler">Default Scheduler</h3>
<ol>
<li>Does the node have adequate hardware resources?</li>
<li>Is the node running out of resources?</li>
<li>Does the pod request a specific node?</li>
<li>Does the node have a matching label?</li>
<li>If the pod requests a port, is it available?</li>
<li>If the pod requests a volume, can it be mounted?</li>
<li>Does the pod tolerate the taints of the node?</li>
<li>Does the pod specify node or pod affinity?</li>
</ol>
<h3 id="custom-scheduler">Custom Scheduler</h3>
<h4 id="clusterrole">ClusterRole</h4>
<pre><code class="yaml">apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: csinodes-admin
rules:
- apiGroups: [&quot;storage.k8s.io&quot;]
  resources: [&quot;csinodes&quot;]
  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]
</code></pre>

<h4 id="clusterrolebinding">ClusterRoleBinding</h4>
<pre><code class="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: read-csinodes-global
subjects:
- kind: ServiceAccount
  name: my-scheduler
  namespace: kube-system
roleRef:
  kind: ClusterRole
  name: csinodes-admin
  apiGroup: rbac.authorization.k8s.io
</code></pre>

<h4 id="role">Role</h4>
<pre><code class="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: system:serviceaccount:kube-system:my-scheduler
  namespace: kube-system
rules:
- apiGroups:
  - storage.k8s.io
  resources:
  - csinodes
  verbs:
  - get
  - list
  - watch
</code></pre>

<h4 id="rolebinding">RoleBinding</h4>
<pre><code class="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-csinodes
  namespace: kube-system
subjects:
- kind: User
  name: kubernetes-admin
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role 
  name: system:serviceaccount:kube-system:my-scheduler
  apiGroup: rbac.authorization.k8s.io
</code></pre>

<h4 id="my-scheduler">My-scheduler</h4>
<pre><code class="yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: my-scheduler
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: my-scheduler-as-kube-scheduler
subjects:
- kind: ServiceAccount
  name: my-scheduler
  namespace: kube-system
roleRef:
  kind: ClusterRole
  name: system:kube-scheduler
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    component: scheduler
    tier: control-plane
  name: my-scheduler
  namespace: kube-system
spec:
  selector:
    matchLabels:
      component: scheduler
      tier: control-plane
  replicas: 1
  template:
    metadata:
      labels:
        component: scheduler
        tier: control-plane
        version: second
    spec:
      serviceAccountName: my-scheduler
      containers:
      - command:
        - /usr/local/bin/kube-scheduler
        - --address=0.0.0.0
        - --leader-elect=false
        - --scheduler-name=my-scheduler
        image: chadmcrowell/custom-scheduler
        livenessProbe:
          httpGet:
            path: /healthz
            port: 10251
          initialDelaySeconds: 15
        name: kube-second-scheduler
        readinessProbe:
          httpGet:
            path: /healthz
            port: 10251
        resources:
          requests:
            cpu: '0.1'
        securityContext:
          privileged: false
        volumeMounts: []
      hostNetwork: false
      hostPID: false
      volumes: []
</code></pre>

<h4 id="deploy">Deploy</h4>
<pre><code class="bash">kubectl create -f clusterrole.yaml
kubectl create -f clusterrolebinding.yaml
kubectl create -f role.yaml
kubectl create -f rolebinding.yaml
kubectl edit clusterrole system:kube-scheduler # And add the following
</code></pre>

<pre><code class="yaml">- apiGroups:
  - &quot;&quot;
  resourceNames:
  - kube-scheduler
  - my-scheduler
  resources:
  - endpoints
  verbs:
  - delete
  - get
  - patch
  - update
- apiGroups:
  - storage.k8s.io
  resources:
  - storageclasses
  verbs:
  - watch
  - list
  - get
</code></pre>

<pre><code class="bash">kubectl create -f my-scheduler.yaml
kubectl get pods -n kube-system
</code></pre>

<h3 id="get-config">Get config</h3>
<pre><code class="bash">kubectl get endpoints kube-scheduler -n kube-system -o yaml
</code></pre>

<h3 id="troubleshooting">Troubleshooting</h3>
<pre><code class="bash">kubectl describe pods [scheduler_pod_name] -n kube-system
kubectl logs [kube_scheduler_pod_name] -n kube-system
cat /var/log/kube-scheduler.log
</code></pre>

<h2 id="rbac">RBAC</h2>
<h3 id="setting-up_3">Setting UP</h3>
<pre><code class="bash"># Create a role with the necessary permissions:
cat &lt;&lt; EOF | kubectl apply --kubeconfig admin.kubeconfig -f -
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
    verbs:
      - &quot;*&quot;
EOF


# Bind the role to the kubernetes user
cat &lt;&lt; EOF | kubectl apply --kubeconfig admin.kubeconfig -f -
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: &quot;&quot;
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kubernetes
EOF
</code></pre>

<h1 id="nodes">Nodes</h1>
<h2 id="install-binaries_1">Install Binaries</h2>
<pre><code class="bash"># You can install the worker binaries like so. Run these commands on both worker nodes:
sudo apt-get -y install socat conntrack ipset

wget -q --show-progress --https-only --timestamping \
  https://github.com/kubernetes-incubator/cri-tools/releases/download/v1.0.0-beta.0/crictl-v1.0.0-beta.0-linux-amd64.tar.gz \
  https://storage.googleapis.com/kubernetes-the-hard-way/runsc \
  https://github.com/opencontainers/runc/releases/download/v1.0.0-rc5/runc.amd64 \
  https://github.com/containernetworking/plugins/releases/download/v0.6.0/cni-plugins-amd64-v0.6.0.tgz \
  https://github.com/containerd/containerd/releases/download/v1.1.0/containerd-1.1.0.linux-amd64.tar.gz \
  https://storage.googleapis.com/kubernetes-release/release/v1.10.2/bin/linux/amd64/kubectl \
  https://storage.googleapis.com/kubernetes-release/release/v1.10.2/bin/linux/amd64/kube-proxy \
  https://storage.googleapis.com/kubernetes-release/release/v1.10.2/bin/linux/amd64/kubelet

sudo mkdir -p \
  /etc/cni/net.d \
  /opt/cni/bin \
  /var/lib/kubelet \
  /var/lib/kube-proxy \
  /var/lib/kubernetes \
  /var/run/kubernetes

chmod +x kubectl kube-proxy kubelet runc.amd64 runsc
sudo mv runc.amd64 runc
sudo mv kubectl kube-proxy kubelet runc runsc /usr/local/bin/
sudo tar -xvf crictl-v1.0.0-beta.0-linux-amd64.tar.gz -C /usr/local/bin/
sudo tar -xvf cni-plugins-amd64-v0.6.0.tgz -C /opt/cni/bin/
sudo tar -xvf containerd-1.1.0.linux-amd64.tar.gz -C /
</code></pre>

<h2 id="containerd">ContainerD</h2>
<pre><code class="bash"># You can configure the containerd service like so. Run these commands on both worker nodes:
sudo mkdir -p /etc/containerd/

# Create the containerd config.toml:
cat &lt;&lt; EOF | sudo tee /etc/containerd/config.toml
[plugins]
  [plugins.cri.containerd]
    snapshotter = &quot;overlayfs&quot;
    [plugins.cri.containerd.default_runtime]
      runtime_type = &quot;io.containerd.runtime.v1.linux&quot;
      runtime_engine = &quot;/usr/local/bin/runc&quot;
      runtime_root = &quot;&quot;
    [plugins.cri.containerd.untrusted_workload_runtime]
      runtime_type = &quot;io.containerd.runtime.v1.linux&quot;
      runtime_engine = &quot;/usr/local/bin/runsc&quot;
      runtime_root = &quot;/run/containerd/runsc&quot;
EOF

# Create the containerd unit file:
cat &lt;&lt; EOF | sudo tee /etc/systemd/system/containerd.service
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target

[Service]
ExecStartPre=/sbin/modprobe overlay
ExecStart=/bin/containerd
Restart=always
RestartSec=5
Delegate=yes
KillMode=process
OOMScoreAdjust=-999
LimitNOFILE=1048576
LimitNPROC=infinity
LimitCORE=infinity

[Install]
WantedBy=multi-user.target
EOF


sudo systemctl daemon-reload
sudo systemctl enable containerd
sudo systemctl start containerd
sudo systemctl status containerd

</code></pre>

<h2 id="kubelet">Kubelet</h2>
<pre><code class="bash"># Set a HOSTNAME environment variable that will be used to generate your config files. Make sure you set the HOSTNAME appropriately for each worker node:

export HOSTNAME=$(hostname)
sudo mv ${HOSTNAME}-key.pem ${HOSTNAME}.pem /var/lib/kubelet/
sudo mv ${HOSTNAME}.kubeconfig /var/lib/kubelet/kubeconfig
sudo mv ca.pem /var/lib/kubernetes/

# Create the kubelet config file:
cat &lt;&lt; EOF | sudo tee /var/lib/kubelet/kubelet-config.yaml
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: false
  webhook:
    enabled: true
  x509:
    clientCAFile: &quot;/var/lib/kubernetes/ca.pem&quot;
authorization:
  mode: Webhook
clusterDomain: &quot;cluster.local&quot;
clusterDNS: 
  - &quot;10.32.0.10&quot;
runtimeRequestTimeout: &quot;15m&quot;
tlsCertFile: &quot;/var/lib/kubelet/${HOSTNAME}.pem&quot;
tlsPrivateKeyFile: &quot;/var/lib/kubelet/${HOSTNAME}-key.pem&quot;
EOF

# Create the kubelet unit file:

cat &lt;&lt; EOF | sudo tee /etc/systemd/system/kubelet.service
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=containerd.service
Requires=containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet \\
  --config=/var/lib/kubelet/kubelet-config.yaml \\
  --container-runtime=remote \\
  --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \\
  --image-pull-progress-deadline=2m \\
  --kubeconfig=/var/lib/kubelet/kubeconfig \\
  --network-plugin=cni \\
  --register-node=true \\
  --v=2 \\
  --hostname-override=${HOSTNAME} \\
  --allow-privileged=true
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable kubelet
sudo systemctl start kubelet
sudo systemctl status kubelet

</code></pre>

<h2 id="kube-proxy">Kube-Proxy</h2>
<pre><code class="bash"># You can configure the kube-proxy service like so. Run these commands on both worker nodes:
sudo mv kube-proxy.kubeconfig /var/lib/kube-proxy/kubeconfig

# Create the kube-proxy config file:
cat &lt;&lt; EOF | sudo tee /var/lib/kube-proxy/kube-proxy-config.yaml
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
clientConnection:
  kubeconfig: &quot;/var/lib/kube-proxy/kubeconfig&quot;
mode: &quot;iptables&quot;
clusterCIDR: &quot;10.200.0.0/16&quot;
EOF

# Create the kube-proxy unit file:
cat &lt;&lt; EOF | sudo tee /etc/systemd/system/kube-proxy.service
[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-proxy \\
  --config=/var/lib/kube-proxy/kube-proxy-config.yaml
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF


sudo systemctl daemon-reload
sudo systemctl enable kube-proxy
sudo systemctl start kube-proxy
sudo systemctl status kube-proxy

</code></pre>

<h1 id="commands">Commands</h1>
<h2 id="components-status">Components Status</h2>
<pre><code class="bash"># Use kubectl to check componentstatuses:

kubectl get componentstatuses --kubeconfig admin.kubeconfig

# You should get output that looks like this:

NAME                 STATUS    MESSAGE              ERROR
controller-manager   Healthy   ok
scheduler            Healthy   ok
etcd-0               Healthy   {&quot;health&quot;: &quot;true&quot;}
etcd-1               Healthy   {&quot;health&quot;: &quot;true&quot;}
</code></pre>

<h1 id="enable-http-health-checks">Enable HTTP Health Checks</h1>
<h2 id="using-nginx-load-balancer">Using Nginx Load Balancer</h2>
<ul>
<li><strong>On Master Nodes</strong></li>
</ul>
<pre><code class="bash"># You can set up a basic nginx proxy for the healthz endpoint by first installing nginx&quot;
sudo apt-get install -y nginx

# Create an nginx configuration for the health check proxy:
cat &gt; kubernetes.default.svc.cluster.local &lt;&lt; EOF
server {
  listen      80;
  server_name kubernetes.default.svc.cluster.local;

  location /healthz {
     proxy_pass                    https://127.0.0.1:6443/healthz;
     proxy_ssl_trusted_certificate /var/lib/kubernetes/ca.pem;
  }
}
EOF

# Set up the proxy configuration so that it is loaded by nginx:
sudo mv kubernetes.default.svc.cluster.local /etc/nginx/sites-available/kubernetes.default.svc.cluster.local
sudo ln -s /etc/nginx/sites-available/kubernetes.default.svc.cluster.local /etc/nginx/sites-enabled/
sudo systemctl restart nginx
sudo systemctl enable nginx

# You can verify that everything is working like so:
curl -H &quot;Host: kubernetes.default.svc.cluster.local&quot; -i http://127.0.0.1/healthz
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../js/base.js" defer></script>
        <script src="../../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
