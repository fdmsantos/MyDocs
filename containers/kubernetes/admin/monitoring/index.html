<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="FÃ¡bio Santos">
        <link rel="canonical" href="https://fdmsantos.github.io/MyDocs/containers/kubernetes/admin/monitoring/">
        <link rel="shortcut icon" href="../../../../img/favicon.ico">
        <title>Monitoring - MyDocs</title>
        <link href="../../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/darcula.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../../..">MyDocs</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../../../..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">AWS <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Networking</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../aws/networking/vpc/">VPC</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Compute</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../aws/compute/ec2/">EC2</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Storage</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../aws/storage/ebs/">EBS</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Deployment</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../aws/deployment/cloudformation/">Cloudformation</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Containers <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Kubernetes</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Admin</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../admin/">Admin</a>
</li>
            
<li >
    <a href="../networking/">Networking</a>
</li>
            
<li >
    <a href="../nodes/">Nodes</a>
</li>
            
<li >
    <a href="../etcd/">Etcd</a>
</li>
            
<li >
    <a href="../scheduler/">Scheduler</a>
</li>
            
<li >
    <a href="../security/">Security</a>
</li>
            
<li >
    <a href="../taint/">Taint</a>
</li>
            
<li >
    <a href="../persistentvolumes/">PersistentVolumes</a>
</li>
            
<li class="active">
    <a href="./">Monitoring</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Development</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../development/pods/">Pods</a>
</li>
            
<li >
    <a href="../../development/deployments/">Deployments</a>
</li>
            
<li >
    <a href="../../development/services/">Services</a>
</li>
            
<li >
    <a href="../../development/ingress/">Ingress</a>
</li>
            
<li >
    <a href="../../development/replicasets/">ReplicaSets</a>
</li>
            
<li >
    <a href="../../development/daemonsets/">DaemonSets</a>
</li>
            
<li >
    <a href="../../development/secrets_configmaps/">Secrets&ConfigMaps</a>
</li>
            
<li >
    <a href="../../development/statefulsets/">StatefulSets</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Databases <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">ELK Stack</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../elk/queries/">ESQueries</a>
</li>
            
<li >
    <a href="../../../../elk/admin/">Administration</a>
</li>
            
<li >
    <a href="../../../../elk/kibana/">Kibana</a>
</li>
            
<li >
    <a href="../../../../elk/beats/">Beats</a>
</li>
            
<li >
    <a href="../../../../elk/snapshotsAndRestore/">Snapshots&Restore</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Unix <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Commands</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../unix/commands/disks/">Disks</a>
</li>
            
<li >
    <a href="../../../../unix/commands/filesystem/">Filesystem</a>
</li>
            
<li >
    <a href="../../../../unix/commands/logging/">Logging</a>
</li>
            
<li >
    <a href="../../../../unix/commands/kernel/">Kernel</a>
</li>
            
<li >
    <a href="../../../../unix/commands/networking/">Networking</a>
</li>
            
<li >
    <a href="../../../../unix/commands/security/">Security</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Software</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Mail</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../unix/software/mail/postfix/">Postfix</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Programming</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../unix/software/programming/php/">PHP</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Virtualization</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../unix/software/virtualization/virsh/">Virsh</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">OperationSystems</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../../unix/os/redhat/">Redhat</a>
</li>
            
<li >
    <a href="../../../../unix/os/debian/">Debian</a>
</li>
            
<li >
    <a href="../../../../unix/os/archlinux/">Archlinux</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../persistentvolumes/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../../development/pods/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/fdmsantos/MyDocs/edit/master/docs/containers/kubernetes/admin/monitoring.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#monitoring">Monitoring</a></li>
            <li><a href="#cluster-components">Cluster Components</a></li>
            <li><a href="#applications">Applications</a></li>
        <li class="main "><a href="#logs">Logs</a></li>
            <li><a href="#cluster">Cluster</a></li>
            <li><a href="#application">Application</a></li>
        <li class="main "><a href="#troubleshooting">Troubleshooting</a></li>
            <li><a href="#applications_1">Applications</a></li>
            <li><a href="#cluster_1">Cluster</a></li>
            <li><a href="#worker-node">Worker Node</a></li>
            <li><a href="#networking">Networking</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="monitoring">Monitoring</h1>
<h2 id="cluster-components">Cluster Components</h2>
<h3 id="metrics-server">Metrics Server</h3>
<pre><code class="bash">git clone https://github.com/linuxacademy/metrics-server
kubectl apply -f ~/metrics-server/deploy/1.8+/

# Get a response from the metrics server API:
kubectl get --raw /apis/metrics.k8s.io/

kubectl top node
kubectl top pods
kubectl top pods --all-namespaces
kubectl top pods -n kube-system
kubectl top pod -l run=pod-with-defaults
kubectl top pod pod-with-defaults

# Get the CPU and memory of the containers inside the pod
kubectl top pods group-context --containers
</code></pre>

<h2 id="applications">Applications</h2>
<h3 id="liveness-probe">Liveness Probe</h3>
<pre><code class="yaml">apiVersion: v1
kind: Pod
metadata:
  name: liveness
spec:
  containers:
  - image: linuxacademycontent/kubeserve
    name: kubeserve
    livenessProbe:
      httpGet:
        path: /
        port: 80
</code></pre>

<h3 id="readiness-probe">Readiness Probe</h3>
<pre><code class="yaml">apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 80
  selector:
    app: nginx
---
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx
    readinessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5
---
apiVersion: v1
kind: Pod
metadata:
  name: nginxpd
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx:191
    readinessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5

</code></pre>

<h1 id="logs">Logs</h1>
<h2 id="cluster">Cluster</h2>
<h3 id="dirs">Dirs</h3>
<ul>
<li><strong>The directory where the continainer logs reside</strong></li>
</ul>
<pre><code class="bash">ls /var/log/containers
</code></pre>

<ul>
<li><strong>The directory where kubelet stores its logs</strong></li>
</ul>
<pre><code class="bash">ls /var/log
</code></pre>

<h3 id="sidecar-container">SideCar Container</h3>
<ul>
<li><strong>The YAML for a sidecar container that will tail the logs for each type</strong></li>
</ul>
<pre><code class="yaml">apiVersion: v1
kind: Pod
metadata:
  name: counter
spec:
  containers:
  - name: count
    image: busybox
    args:
    - /bin/sh
    - -c
    - &gt;
      i=0;
      while true;
      do
        echo &quot;$i: $(date)&quot; &gt;&gt; /var/log/1.log;
        echo &quot;$(date) INFO $i&quot; &gt;&gt; /var/log/2.log;
        i=$((i+1));
        sleep 1;
      done
    volumeMounts:
    - name: varlog
      mountPath: /var/log
  - name: count-log-1
    image: busybox
    args: [/bin/sh, -c, 'tail -n+1 -f /var/log/1.log']
    volumeMounts:
    - name: varlog
      mountPath: /var/log
  - name: count-log-2
    image: busybox
    args: [/bin/sh, -c, 'tail -n+1 -f /var/log/2.log']
    volumeMounts:
    - name: varlog
      mountPath: /var/log
  volumes:
  - name: varlog
    emptyDir: {}

</code></pre>

<pre><code class="bash">kubectl logs counter count-log-1
kubectl logs counter count-log-2
</code></pre>

<h2 id="application">Application</h2>
<pre><code class="bash"># Get the logs from a pod:
kubectl logs nginx

# Get the logs from a specific container on a pod:
kubectl logs counter -c count-log-1

# Get the logs from all containers on the pod:
kubectl logs counter --all-containers=true

# Get the logs from containers with a certain label:
kubectl logs -lapp=nginx

# Get the logs from a previously terminated container within a pod:
kubectl logs -p -c nginx nginx

# Stream the logs from a container in a pod:
kubectl logs -f -c count-log-1 counter

# Tail the logs to only view a certain number of lines:
kubectl logs --tail=20 nginx

# View the logs from a previous time duration:
kubectl logs --since=1h nginx

# View the logs from a container within a pod within a deployment:
kubectl logs deployment/nginx -c nginx

# Redirect the output of the logs to a file:
kubectl logs counter -c count-log-1 &gt; count.log
</code></pre>

<h1 id="troubleshooting">Troubleshooting</h1>
<h2 id="applications_1">Applications</h2>
<h3 id="use-termination-reason">Use Termination Reason</h3>
<pre><code class="yaml">apiVersion: v1
kind: Pod
metadata:
  name: pod2
spec:
  containers:
  - image: busybox
    name: main
    command:
    - sh
    - -c
    - 'echo &quot;I''ve had enough&quot; &gt; /var/termination-reason ; exit 1'
    terminationMessagePath: /var/termination-reason
</code></pre>

<h3 id="healthz">Healthz</h3>
<ul>
<li><strong>Not all pods have healthz configured</strong></li>
</ul>
<pre><code class="yaml">apiVersion: v1
kind: Pod
metadata:
  name: liveness
spec:
  containers:
  - image: linuxacademycontent/candy-service:2
    name: kubeserve
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8081
</code></pre>

<h3 id="steps">Steps</h3>
<pre><code class="yaml">kubectl describe po pod2
kubectl logs pod-with-defaults
kubectl get po pod-with-defaults -o yaml --export &gt; defaults-pod.yaml
</code></pre>

<h2 id="cluster_1">Cluster</h2>
<pre><code class="bash"># Check the events in the kube-system namespace for errors
kubectl get events -n kube-system

kubectl logs [kube_scheduler_pod_name] -n kube-system

# Check the status of the Docker service:
sudo systemctl status docker
sudo systemctl enable docker &amp;&amp; systemctl start docker

# Check the status of the kubelet service:
sudo systemctl status kubelet
sudo systemctl enable kubelet &amp;&amp; systemctl start kubelet

# Turn off swap on your machine
sudo su -
swapoff -a &amp;&amp; sed -i '/ swap / s/^/#/' /etc/fstab

# Check if you have a firewall running:
sudo systemctl status firewalld
sudo systemctl disable firewalld &amp;&amp; systemctl stop firewalld
</code></pre>

<h2 id="worker-node">Worker Node</h2>
<pre><code class="bash">kubectl get nodes
kubectl describe nodes chadcrowell2c.mylabserver.com

# Create New Worker Server
# Generate a new token after spinning up a new server:
sudo kubeadm token generate

# Create the kubeadm join command for your new worker node:
# sudo kubeadm token create [token_name] --ttl 2h --print-join-command

# View the journalctl logs:
sudo journalctl -u kubelet

# View the syslogs:
sudo more syslog | tail -120 | grep kubelet
</code></pre>

<h2 id="networking">Networking</h2>
<h3 id="dns">DNS</h3>
<pre><code class="bash"># Run an interactive busybox pod:
kubectl run -it --rm --restart=Never busybox --image=busybox:1.28 sh

# From the pod, check if DNS is resolving hostnames:
nslookup hostnames

# From the pod, cat out the /etc/resolv.conf file:
cat /etc/resolv.conf

# From the pod, look up the DNS name of the Kubernetes service:
nslookup kubernetes.default
nslookup kube-dns.kube-system.svc.cluster.loca

# Look up a service in your Kubernetes cluster
nslookup [pod-ip-address].default.pod.cluster.local

# Logs Core Dns
kubectl logs [coredns-pod-name]
</code></pre>

<h3 id="kube-proxy">Kube-Proxy</h3>
<pre><code class="bash"># View the endpoints for your service:
kubectl get ep

# Communicate with the pod directly (without the service):
wget -qO- 10.244.1.6:9376

# Check if kube-proxy is running on the nodes:
ps auxw | grep kube-proxy

# Check if kube-proxy is writing iptables:
kubectl get services -o wide
iptables-save | grep hostnames
sudo iptables-save | grep KUBE | grep &lt;service-name&gt;

# View the list of kube-system pods:
kubectl get pods -n kube-system

# Connect to your kube-proxy pod in the kube-system namespace:
kubectl exec -it kube-proxy-cqptg -n kube-system -- sh
</code></pre>

<h3 id="change-cni-plugin">Change CNI Plugin</h3>
<pre><code class="bash"># Delete the flannel CNI plugin:
kubectl delete -f https://raw.githubusercontent.com/coreos/flannel/bc79dd1505b0c8681ece4de4c0d86c5cd2643275/Documentation/kube-flannel.yml

# Apply the Weave Net CNI plugin:

kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')&quot;
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../js/base.js" defer></script>
        <script src="../../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
